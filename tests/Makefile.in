# $Header: /Users/kamil/work/gasnet-cvs2/gasnet/tests/Makefile.in,v 1.13 2004/02/09 19:40:47 phargrov Exp $
# Description: Makefile for GASNet tests
# Copyright 2002, Dan Bonachea <bonachea@cs.berkeley.edu>
# Terms of use are as specified in license.txt

all:
	@echo This Makefile is not intended to be called directly
	@echo do a "make tests-seq" or "make tests-par" within the conduit directory

# linker to be used for MPI programs
GASNET_MPI_LD = @MPI_CC@

configfile=/dev/null # must be overridden by caller
include $(configfile)

@USE_MPI_CONDUIT_TRUE@ MPI_TEST = testmpi

testprograms_seq =  \
	testam      \
	testbarrier \
	testcore1   \
	testexit    \
	testgasnet  \
	testhsl     \
	testlarge   \
	testlogGP   \
	testmisc    \
	testsmall   \
	testalign   \
	testrand    \
	testtools

testprograms_parsync =  \

testprograms_par =  \
	testthreads \
	$(MPI_TEST)

testprograms = $(testprograms_seq) $(testprograms_parsync) $(testprograms_par)

tests-seq: clean $(testprograms_seq)
	
tests-parsync: clean $(testprograms_seq) $(testprograms_parsync)
	
tests-par: clean $(testprograms_seq) $(testprograms_parsync) $(testprograms_par)
	
clean:
	rm -f $(testprograms:=@EXESUFFIX@)

distclean: 
	rm -f Makefile

# testtools is a special minimal case for an app that just uses GASNet tools
testtools: force
	@CC@ @MISC_CFLAGS@ $(GASNET_INCLUDES) @GASNET_THREAD_DEFINES@ -DHAVE_PTHREAD_H -c -o $@.o $(srcdir)/$@.c
	@CC@ -o $@ $@.o @GASNET_THREAD_LIBS@ @LIBS@ @LIBM@

# testlogGP needs an external file w/ the delay function.
testlogGP: force delay.o
	$(GASNET_CC) -I$(srcdir) $(GASNET_CPPFLAGS) $(GASNET_CFLAGS) -c -o $@.o $(srcdir)/$@.c
	$(GASNET_LD) $(GASNET_LDFLAGS) -o $@ $@.o delay.o $(GASNET_LIBS)
delay.o: $(srcdir)/delay.c
	$(GASNET_CC) -O0 -c -o $@ $(srcdir)/$*.c

# testmpi must be compiled like an MPI program with GASNet support
testmpi: force
	@MPI_CC@ -I$(srcdir) $(GASNET_CPPFLAGS) $(GASNET_CFLAGS) @MPI_CFLAGS@ -c -o $@.o $(srcdir)/$@.c
	$(GASNET_MPI_LD) $(GASNET_LDFLAGS) @MPI_CFLAGS@ -o $@ $@.o @MPI_LIBS@ $(GASNET_LIBS)
	

# This is a model for how GASNet clients should be built:
test% : force
	$(GASNET_CC) -I$(srcdir) $(GASNET_CPPFLAGS) $(GASNET_CFLAGS) -c -o $@.o $(srcdir)/$@.c
	$(GASNET_LD) $(GASNET_LDFLAGS) -o $@ $@.o $(GASNET_LIBS)

force:
	

.PHONY: force all

